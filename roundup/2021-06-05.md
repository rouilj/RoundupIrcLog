# Roundup IRC Log for 2021-06-05 #
# Roundup IRC Log for 2021-06-05
* <a href="#16:49.09" id="16:49.09">16:49.09 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: I'm now feeling a bit more stuck on importing the csv export. I've gone back to roundup 1.4.15, which is the version we have in production, and copied our exact schema too, and even then I can't import:
* <a href="#16:49.18" id="16:49.18">16:49.18 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: IntegrityError: UNIQUE constraint failed: _user.__retired__, _user._username
* <a href="#16:50.07" id="16:50.07">16:50.07 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: which, as an error, seems justified, as we do have duplicate usernames in our users database, as it seems possible to reuse a username after it has been retired, then re-retire the new one.
* <a href="#16:50.21" id="16:50.21">16:50.21 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: but then why were we able to get into this state to begin with?
* <a href="#16:51.08" id="16:51.08">16:51.08 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: the only difference now is that the export is from postgres and I'm importing into sqlite; I'll try importing into postgres too next. But that would be pretty annoying if we were constrained to postgres by our data.
* <a href="#16:51.27" id="16:51.27">16:51.27 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: I also need to investigate whether all these duplicates are actually spammers and maybe we should just filter them out when we import.
* <a href="#16:52.12" id="16:52.12">16:52.12 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: rouilj: btw I really appreciate your help and feedback here, but if you think I should just try the mailing list directly, let me know.
* <a href="#17:00.28" id="17:00.28">17:00.28 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: no, some of the duplicates are genine users
* <a href="#17:00.32" id="17:00.32">17:00.32 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: *genuine
* <a href="#17:24.49" id="17:24.49">17:24.49 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: my next idea is just to munge the CSV file to rename the retired ones if needed
* <a href="#18:01.58" id="18:01.58">18:01.58 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: Hi Heffalump. That's umm interesting. Could you bring this up on the mailing list. I think editing the username for retired users to make them unique should work. But yeah you shouldn't get into that state to begin with. Usernames (even if retired) should be unique.
* <a href="#18:03.28" id="18:03.28">18:03.28 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: Since a retired user isn't wiped from tickets, assignments (links, nosy lists etc.) it would be confusing if there were two different people with the same name.
* <a href="#18:12.32" id="18:12.32">18:12.32 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: I am not sure how you got into that state. AFAICT if the user class has the username as the key, that key has a unique constraint on it. I'll have to check with somebody who has a better handle on the sql, bt it looks like it's a composite key. The sql is: 'create unique index _user_key_retired_idx on _user(__retired__, username)'  (assuming username is the key). I have a sqlite demo ste up. Let me try creating a new user. retire
* <a href="#18:12.33" id="18:12.33">18:12.33 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: er. create a new user with same name.
* <a href="#18:22.34" id="18:22.34">18:22.34 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: hmm curious. sqlite> select id, _username, __retired__ from _user order by id;
* <a href="#18:22.34" id="18:22.34">18:22.34 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: 1|admin|0
* <a href="#18:22.34" id="18:22.34">18:22.34 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: ...
* <a href="#18:22.34" id="18:22.34">18:22.34 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: 22|duplicate|22
* <a href="#18:22.35" id="18:22.35">18:22.35 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: 23|duplicate|23
* <a href="#18:22.35" id="18:22.35">18:22.35 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: 24|duplicate|0
* <a href="#18:23.46" id="18:23.46">18:23.46 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: so it looks like __retired__ is the user id. Heffalump can you check your csv output and see if the __retired__ field exists and if so does it have a unique number or 0 in the column?
* <a href="#18:30.05" id="18:30.05">18:30.05 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: yeah that does look like a bug. I exported the user table using: roundup-admin -i . exporttables user exp (you might not have exporttables in your version). The header row and a retired user looks like
* <a href="#18:30.34" id="18:30.34">18:30.34 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: activity:actor:address:alternate_addresses:autodisplayimage:creation:creator:id:issue_collapsed_fieldsets:nosy_keywords:organisation:password:phone:queries:realname:roles:theme:timezone:username:is retired
* <a href="#18:30.34" id="18:30.34">18:30.34 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: (2021, 6, 5, 22, 17, 28.615, 0, 0, 0):'1':'dupe@example.com':None:1:(2021, 6, 5, 22, 17, 28.615, 0, 0, 0):'1':'22':None:[]:None:'{PBKDF2}10000$0vAr/uiKKHj0QMtzm7X0ZCOqfHY$iEHn2y/bCAqvVzutYQrlnxoABmA':None:[]:'duplicate':'Provisional User':None:'0':'duplicate':True
* <a href="#18:31.24" id="18:31.24">18:31.24 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: (2021, 6, 5, 22, 20, 5.85, 0, 0, 0):'1':'dupl@example.com':None:1:(2021, 6, 5, 22, 20, 5.85, 0, 0, 0):'1':'24':None:[]:None:'{PBKDF2}10000$HG9yHzAd8sNofzGBucR/0yyIErQ$1mS6jJLJKoHCWtRCgN2uoJlFMpY':None:[]:'duplicate':'Provisional User':None:'0':'duplicate':False
* <a href="#18:31.24" id="18:31.24">18:31.24 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: you only get True/false for retired. Not the id number in the original database.
* <a href="#18:32.28" id="18:32.28">18:32.28 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: I'll do a write up for developers and see if anybody has an idea on how to fix this. For your use case, I think munging the usernames for the duplicate users is the way to go. Sorry this bug bit you.
* <a href="#19:09.18" id="19:09.18">19:09.18 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: yes, __retired__ is True/False
* <a href="#19:09.34" id="19:09.34">19:09.34 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: I was assuming from the error that things only go wrong once the same username is used the third time
* <a href="#19:09.40" id="19:09.40">19:09.40 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: or at least the same username is retired twice
* <a href="#19:11.01" id="19:11.01">19:11.01 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: ahh, so the DB has numbers but somehow they turn into True/False in the export? That's unfortunate (but seems easier to recover from in a sense given the right info is actually available)
* <a href="#19:11.14" id="19:11.14">19:11.14 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: but anyway munging seems like a reasonable workaround
* <a href="#19:11.33" id="19:11.33">19:11.33 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: thanks a lot for looking into it!
* <a href="#19:46.24" id="19:46.24">19:46.24 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: 'same username is retired twice' yes that's how I read it. It looks like on import the same value is used for _retired__ both times and boom.
* <a href="#19:52.59" id="19:52.59">19:52.59 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: rouilj: that unfortunately seems to have happened several times in our history (a quick cut/uniq on the CSV file finds about 10)
* <a href="#19:53.18" id="19:53.18">19:53.18 (EDT)</a> - __[Heffalump](https://github.com/Heffalump)__: oh well, good chance to learn a bit more Python :-)
* <a href="#20:27.12" id="20:27.12">20:27.12 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: I am going to run it through the debugger and see if I can come up with a quick fix. There is a warning in that section of code that I don't understand. Your issue is discussed on roundup-devel <https://sourceforge.net/p/roundup/mailman/roundup-devel>/. Looks like mail there is slow or I would have given you the exact thread start.
* <a href="#20:51.18" id="20:51.18">20:51.18 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: Heffalump, for the user with the duplicate name, does the non-retired entry in the csv occur before the retired entries in the csv?
* <a href="#20:52.25" id="20:52.25">20:52.25 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: If so, munge the csv to put the non-retired user after all the retired users with the same name. It should be the same as sorting by id.
* <a href="#20:53.13" id="20:53.13">20:53.13 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: The code in 2.x at least does the right thing if the active user is processed after all the retired entries using the same name.
* <a href="#20:55.49" id="20:55.49">20:55.49 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: and it looks almost the same in 1.4
* <a href="#21:01.02" id="21:01.02">21:01.02 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: sort in 1.4.15, 1.4 would be just as broken as it sets retired to 1 not to the id. 1.4.2 supplied the fix.
* <a href="#21:11.01" id="21:11.01">21:11.01 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: heffalump, question in the csv for your duplicate user (I'll call it duser), are all the duser entries clustered together with the active user first?
* <a href="#21:49.28" id="21:49.28">21:49.28 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: For those following in the logs or at home, 'same username is retired twice' may not be required. One retirement may be sufficient if the order of entries returned from the database layer puts the non-retired entry first and follows it by the retired entry. This can happen if the entries aren't sorted by ID.
* <a href="#23:57.06" id="23:57.06">23:57.06 (EDT)</a> - __[rouilj](https://github.com/rouilj)__: Another possible workaround, retire all of the duplicate usernames, export/import restore the userXX you want. The id numbers should be preserved so this makes it easy.
